const registerData = {}
var socketUserList = [], users = [], loadTime = new Date().getTime(), preTime = new Date().getTime(), roomUser = null, inLineUserList = [], relevantUserList = [];
const socket = io("http://localhost:3000/");

window.onload = function () {
    (function () {
        //åˆ¤æ–­æ˜¯å¦å·²ç»ç™»å½•
        // initIsLogin()
        //åˆå§‹åŒ–é€‰æ‹©å¤´åƒ
        initAvatar()
    })()

    // function initIsLogin() {
    //     // ç™»å½•ç›´æ¥åˆ°message box
    //     if(JSON.stringify(registerData) != "{}"){
    //         $(".register-box").hide();
    //         $("#windowBox").show();
    //     } 
    // }

    function initAvatar() {
        var avatarList = document.getElementById("avatarList");
        var avatarDom = document.createDocumentFragment()
        for (var i = 1; i <= 8; i++) {
            (function () {
                var img = document.createElement("img");
                img.src = "http://localhost:3000/image/avatar" + i + ".jpg";
                img.className = i === 1 ? "avatar-login avatar-login-on" : "avatar-login"
                img.onclick = function () {
                    selectAvatar(img)
                }
                avatarDom.appendChild(img)
            })()
        }
        avatarList.appendChild(avatarDom)
    }

    function selectAvatar(img) {
        var avatarDom = document.getElementsByClassName("avatar-login")
        for (var i = 0; i < avatarDom.length; i++) {
            if (avatarDom[i].classList.contains("avatar-login-on")) {
                avatarDom[i].classList.remove("avatar-login-on")
                break
            }
        }
        img.className = "avatar-login avatar-login-on"
        registerData.avatar = img.src
    }
}


//æäº¤ç™»å½•æ•°æ®
function registerFn() {
    var nickname = document.getElementById("nickname").value;
    var avatar = $(".avatar-login-on").attr("src");
    var sex = $("input:radio:checked").val();
    socket.emit("login", {
        nickname: nickname,
        avatar: avatar,
        sex: sex
    })
}

socket.on("error-login", data => {
    alert(data.msg)
})

socket.on("success-login", data => {
    $(".register-box").fadeOut();
    $("#windowBox").css('display', "flex");
    registerData.nickname = data.nickname;
    registerData.sex = data.sex;
    registerData.avatar = data.avatar;
    let sex_url = `http://localhost:3000/image/sex${data.sex}.png`;
    $("#avatar_url").attr("src", data.avatar);
    $(".user-list-header-txt>p>span").text(data.nickname);
    $(".user-list-header-txt>p:eq(1)").text(data.nickname);
    $(".user-list-header-txt>p>img").attr('src', sex_url);
    initEnjoy()
})



//ç›‘å¬æ–°å¢ç”¨æˆ·
socket.on("addUser", data => {
    $(".message-box-content").append(`
        <div class="message-system">${data.nickname}è¿›å…¥èŠå¤©å®¤</div>
    `)
})

//ç›‘å¬æ‰€æœ‰ç”¨æˆ·
socket.on("userList", data => {
    $('.user-list-items-all').html('');
    data.forEach(e => {
        $(".user-list-items-all").append(`
        <div class="user-list-header user-list-item">
            <div class="user-list-header-avatar user-list-item-header-avatar">
                <img src="${e.avatar}" alt="">
            </div>
            <div class="user-list-header-txt">
                <span class="user-list-header-nickname user-list-item-header-nickname">${e.nickname}</span>
                <img src="http://localhost:3000/image/sex${e.sex}.png" class="user-list-header-avatar-sex">
            </div>
        </div>
        `)
    });

    $("#message-box-title-inline").text(`èŠå¤©å®¤(${data.length})`);
})
//ç›‘å¬åˆ é™¤ç”¨æˆ·
socket.on("delUser", data => {
    //æ·»åŠ ç¦»å¼€ä¿¡æ¯
    $(".message-box-content").append(`
        <div class="message-system">${data.nickname}éª‚éª‚å’§å’§åœ°ç¦»å¼€äº†èŠå¤©å®¤</div>
    `)
})

//èŠå¤©åŠŸèƒ½
function sendMessage() {
    //è·å–å†…å®¹
    let content = $(".message-box-system-message-c").val().trim()
    console.log(content)
    //æ¸…æ¥šå†…å®¹
    $(".message-box-system-message-c").val("")
    //åˆ¤æ–­ä¸ä¸ºç©º 
    if (!content) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º")

    //å‘é€æœåŠ¡å™¨
    socket.emit("sendMessage", {
        'msg': content,
        'user': registerData
    });
}

//ç›‘å¬å…¨å±€ä¿¡æ¯
socket.on("content",data=>{
    console.log(data)
    //åˆ¤æ–­å½“å‰ä¿¡æ¯æ˜¯å¦ä¸ºè‡ªå·±å¾—
    if(data.user.nickname!=registerData.nickname){
        //ä¸æ˜¯è‡ªå·±çš„å¾€å·¦è¾¹é 
        $('.message-box-content').append(`
            <div class="message-item left">
                <div class="message-item-u">
                    <img src="${data.user.avatar}" alt="" class="message-item-avatar">
                    <div class="message-item-content">
                        <p class="message-item-content-nickname">${data.user.nickname}</p>
                        <div class="message-item-content-bubble">${data.msg}</div>
                    </div>
                </div>
             </div>
        `)
    }else{
        $('.message-box-content').append(`
            <div t="1594023891000" class="message-item right">
                <div class="message-item-u">
                    <div class="message-item-content">
                        <div class="message-item-content-bubble">
                            ${data.msg}
                        </div>
                    </div>
                    <img class="message-item-avatar" src="${data.user.avatar}">
                </div>
            </div>
        `)
    }
    //å½“å‰å…ƒç´ å¾—åº•éƒ¨æ»šåŠ¨åˆ°å¯è§†åŒº
    $('.message-box-content').children(":last").get(0).scrollIntoView(false);
})



// è¡¨æƒ…
function showEnjoy(n) {
    document.getElementsByClassName("enjoy-view")[0].style.display = ["none", "inline-block"][n]
}
//åŠ è½½è¡¨æƒ… 
function initEnjoy() {
    var enjoy = ["ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†", "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜", "ğŸ˜", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", "â˜º", "ğŸ˜‡", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¶", "ğŸ˜", "ğŸ˜£", "ğŸ˜¥", "ğŸ˜®", "ğŸ˜¯", "ğŸ˜ª", "ğŸ˜«", "ğŸ˜´", "ğŸ˜Œ", "ğŸ˜›", "ğŸ˜œ", "ğŸ˜", "ğŸ˜’", "ğŸ˜“", "ğŸ˜”", "ğŸ˜•", "ğŸ˜²", "ğŸ˜·", "ğŸ˜–", "ğŸ˜", "ğŸ˜Ÿ", "ğŸ˜¤", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜¨", "ğŸ˜¬", "ğŸ˜°", "ğŸ˜±", "ğŸ˜³", "ğŸ˜µ", "ğŸ˜¡", "ğŸ˜ ", "ğŸ˜ˆ", "ğŸ‘¿", "ğŸ‘¹", "ğŸ‘º", "ğŸ’€", "ğŸ‘»", "ğŸ‘½", "ğŸ‘¦", "ğŸ‘§", "ğŸ‘¨", "ğŸ‘©", "ğŸ‘´", "ğŸ‘µ", "ğŸ‘¶", "ğŸ‘±", "ğŸ‘®", "ğŸ‘²", "ğŸ‘³", "ğŸ‘·", "ğŸ‘¸", "ğŸ’‚", "ğŸ…", "ğŸ‘°", "ğŸ‘¼", "ğŸ’†", "ğŸ’‡", "ğŸ™", "ğŸ™", "ğŸ™…", "ğŸ™†", "ğŸ’", "ğŸ™‹", "ğŸ™‡", "ğŸ™Œ", "ğŸ™", "ğŸ‘¤", "ğŸ‘¥", "ğŸš¶", "ğŸƒ", "ğŸ‘¯", "ğŸ’ƒ", "ğŸ‘«", "ğŸ‘¬", "ğŸ‘­", "ğŸ’", "ğŸ’‘", "ğŸ‘ª", "ğŸ’ª", "ğŸ‘ˆ", "ğŸ‘‰", "â˜", "ğŸ‘†", "ğŸ‘‡", "âœŒ", "âœ‹", "ğŸ‘Œ", "ğŸ‘", "ğŸ‘", "âœŠ", "ğŸ‘Š", "ğŸ‘‹", "ğŸ‘", "ğŸ‘", "âœ", "ğŸ‘£", "ğŸ‘€", "ğŸ‘‚", "ğŸ‘ƒ", "ğŸ‘…", "ğŸ‘„", "ğŸ’‹", "ğŸ‘“", "ğŸ‘”", "ğŸ‘•", "ğŸ‘–", "ğŸ‘—", "ğŸ‘˜", "ğŸ‘™", "ğŸ‘š", "ğŸ‘›", "ğŸ‘œ", "ğŸ‘", "ğŸ’", "ğŸ’¼", "ğŸ‘", "ğŸ‘Ÿ", "ğŸ‘ ", "ğŸ‘¡", "ğŸ‘¢", "ğŸ‘‘", "ğŸ‘’", "ğŸ©", "ğŸ“", "ğŸ’„", "ğŸ’…", "ğŸ’", "ğŸŒ‚", "ğŸŒ¹", "ğŸ€", "ğŸ", "ğŸ’°", "ğŸ“±", "ğŸŒ™", "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸŒ·", "ğŸ’", "ğŸ”ª", "ğŸ”«", "ğŸ€", "âš½", "âš¡", "ğŸ‘„", "ğŸ‘", "ğŸ”¥"]
    var enjoyDom = document.createDocumentFragment()
    var tr = document.createElement("tr");
    for (var i = 1; i <= enjoy.length; i++) {
        (function (i) {
            var td = document.createElement("td");
            td.onmousedown = function () {
                var messageBoxSystemMessageC = document.getElementsByClassName("message-box-system-message-c")[0]
                var cursorPositionIndex = getPursorPositionIndex()
                var selectionText = getSelectionText()
                var oldValue = messageBoxSystemMessageC.value
                if (messageBoxSystemMessageC === document.activeElement) {
                    //é€‰ä¸­æœ‰å†…å®¹ å†…å®¹æ›¿æ¢è¡¨æƒ…
                    if (selectionText) {
                        //æˆªå–å…‰æ ‡åçš„å†…å®¹
                        messageBoxSystemMessageC.value = oldValue.substring(0, cursorPositionIndex) + oldValue.substring(cursorPositionIndex, oldValue.length).replace(selectionText, enjoy[i - 1])
                    }
                    else if (cursorPositionIndex !== undefined) {//æ²¡é€‰å†…å®¹ æ’å…¥è¡¨æƒ…
                        messageBoxSystemMessageC.value = oldValue.substring(0, cursorPositionIndex) + enjoy[i - 1] + oldValue.substring(cursorPositionIndex, oldValue.length)
                    }
                } else {
                    messageBoxSystemMessageC.value = oldValue + enjoy[i - 1]
                }
                document.getElementsByClassName("enjoy-view")[0].style.display = "none"
            }
            td.innerText = enjoy[i - 1]
            tr.appendChild(td)
            if (i % 12 === 0) {
                enjoyDom.appendChild(tr)
                tr = document.createElement("tr");
            }
        })(i)
    }
    enjoyDom.appendChild(tr)
    document.getElementById("enjoyViewTable").appendChild(enjoyDom)
    let obj = new Date();
    let hour = obj.getHours();
    let minute = obj.getMinutes();
    $(".message-box-content").append(`
        <p class="message-time">ä»Šå¤©${hour}:${minute}</p>
    `)
}

// å‘é€å›¾ç‰‡
function choiceImg(e) {
    if (!initSuccess) return alert("è¯·åœ¨åˆå§‹åŒ–æˆåŠŸåå†å‘é€å›¾ç‰‡")
    var file = e.files[0]
    var formData = new FormData()
    formData.append("file", file)
    Ajax.post(activePath.requestAddress + "/upload/image", formData, function (e) {
        var message = {
            launchId: userData.socketId,
            receiveId: roomUser ? roomUser.socketId : -1,
            content: e,
            type: 4
        }
        if (roomUser == null) {
            // ç¾¤èŠ
            wsControllerM.ws.send(JSON.stringify(message))
        } else {
            //ç§èŠ
            message.createTime = new Date().getTime()
            message.static = true
            handelMessageFn.s4(message)
            if (!roomUser.inline) {
                message.type = 40
                // ä¸åœ¨çº¿ æäº¤ç”¨æˆ·id
                message.receiveId = roomUser.id
            }
            wsControllerM.ws.send(JSON.stringify(message))
        }
    }, true)
}

//ctrl+enter
document.onkeydown = function (e) {
    var keyCode = e.keyCode || e.which || e.charCode;
    if (e.ctrlKey && keyCode === 13) {
        sendMessage()
    }
}

//è·å–å…‰æ ‡ä½ç½®
function getPursorPositionIndex(){
    var oTxt1 = document.getElementsByClassName("message-box-system-message-c")[0];
    try {
        var cursurPosition=-1;
        if(oTxt1.selectionStart){//éIEæµè§ˆå™¨e799bee5baa6e997aee7ad94e59b9ee7ad9431333330333630
            cursurPosition= oTxt1.selectionStart;
        }else{//IE
            var range = document.selection.createRange();
            range.moveStart("character",-oTxt1.value.length);
            cursurPosition=range.text.length;
        }
    }catch (e) {

    }
    return cursurPosition;
}
//è·å–å…‰æ ‡é€‰ä¸­çš„å†…å®¹
function getSelectionText() {
    if(window.getSelection) {
        return window.getSelection().toString();
    } else if(document.selection && document.selection.createRange) {
        return document.selection.createRange().text;
    }
    return '';
}

